# ==============================================================================
# Docker Compose 配置文件 - 数据相关服务
# ==============================================================================
# 注意：version字段在新版本Docker Compose中已废弃，但保留以兼容旧版本
# 如果看到警告，可以安全地忽略或移除version字段
# ==============================================================================
# 环境变量配置：
# 1. 所有配置已抽离到 .env 文件中，便于统一管理
# 2. 首次使用前，请创建 .env 文件（参考 ENV_SETUP.md）
# 3. Docker Compose 会自动读取 .env 文件中的环境变量
# 4. 所有变量都有默认值，可以不设置 .env 文件（不推荐）
# ==============================================================================
# 使用说明：
# 1. 确保先启动主服务：docker-compose up -d
# 2. 然后启动数据服务：docker-compose -f docker-compose-data.yml up -d
# ==============================================================================

services:
  # ============================================================================
  # Data Manager服务（数据代理管理器）
  # ============================================================================
  # 此服务负责管理所有 data_agent 实例，包括注册、心跳、任务分配等
  data-manager:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${DATA_MANAGER_CONTAINER_NAME:-aifuturetrade-data-manager}
    command: ["python", "data/data_manager.py"]
    # Data Manager服务端口（用于接收 data_agent 的注册和心跳）
    ports:
      - "${DATA_MANAGER_PORT:-8888}:8888"  # Data Manager注册接口端口
    volumes:
      - ./data:/app/data
    # 依赖 async-agent（来自主docker-compose.yml），确保 async-agent 先启动（提供 market_tickers 数据）
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=${PYTHONPATH:-/app}
      # MySQL配置（在Docker网络中使用服务名 'mysql'）
      - MYSQL_HOST=mysql
      - MYSQL_PORT=${MYSQL_CONTAINER_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-aifuturetrade}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-aifuturetrade123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-aifuturetrade}
      # Data Agent配置
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL:-150}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT:-8888}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE:-20}
      - DATA_AGENT_COMMAND_TIMEOUT=${DATA_AGENT_COMMAND_TIMEOUT:-90}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT:-60}
      - DATA_AGENT_STATUS_CHECK_INTERVAL=${DATA_AGENT_STATUS_CHECK_INTERVAL:-60}
      - DATA_AGENT_FULL_SYNC_INTERVAL=${DATA_AGENT_FULL_SYNC_INTERVAL:-180}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # Data Agent服务（K线数据同步）
  # ============================================================================
  # 注意：在 Docker 网络中，DATA_AGENT_REGISTER_IP 应设置为服务名 'data-manager'
  data-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${DATA_AGENT_CONTAINER_NAME:-aifuturetrade-data-agent}
    command: ["python", "data/data_agent.py"]
    # Data Agent服务端口
    ports:
      - "${DATA_AGENT_PORT:-9999}:9999"  # Data Agent指令接口端口（用于接收指令，如添加symbol等）
      - "${DATA_AGENT_STATUS_PORT:-9988}:9988"  # Data Agent状态检查端口（独立端口，用于健康检查，避免指令服务阻塞）
    volumes:
      - ./data:/app/data
    # 依赖 data-manager，确保 data-manager 先启动（用于注册）
    depends_on:
      - data-manager
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=${PYTHONPATH:-/app}
      # MySQL配置（在Docker网络中使用服务名 'mysql'）
      - MYSQL_HOST=mysql
      - MYSQL_PORT=${MYSQL_CONTAINER_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-aifuturetrade}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-aifuturetrade123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-aifuturetrade}
      # Data Agent配置
      # 注意：在 Docker 网络中，DATA_AGENT_REGISTER_IP 应设置为服务名 'data-manager'
      # 如果未设置环境变量，使用 'data-manager' 作为默认值
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL:-150}
      - DATA_AGENT_PORT=${DATA_AGENT_PORT:-9999}
      - DATA_AGENT_REGISTER_IP=${DATA_AGENT_REGISTER_IP:-data-manager}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT:-8888}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE:-20}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT:-60}
      - DATA_AGENT_SELF_UPDATE_INTERVAL=${DATA_AGENT_SELF_UPDATE_INTERVAL:-60}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

# ==============================================================================
# 网络配置
# ==============================================================================
# 注意：网络名称与docker-compose-mysql.yml和docker-compose.yml中的网络名称相同
# Docker Compose会自动合并相同名称的网络，使服务可以互相通信
# 注意：网络名称使用硬编码，确保与其他compose文件一致
networks:
  aifuturetrade-network:
    driver: bridge
