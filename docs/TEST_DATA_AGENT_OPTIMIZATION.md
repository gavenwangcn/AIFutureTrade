# test_data_agent.py ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–ç›®æ ‡

ä¼˜åŒ– `test_data_agent.py` çš„æµ‹è¯•é€»è¾‘ï¼Œä½¿å…¶ä¸ `websocket_klines.py` ä¸€è‡´ï¼š
- åŒæ—¶æ„å»ºæ‰€æœ‰ interval çš„ç›‘å¬
- æ¯ä¸ª interval æŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯ï¼ˆx=Trueï¼‰
- æ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯åç«‹å³å…³é—­è¯¥ interval çš„ç›‘å¬
- æ‰€æœ‰ interval éƒ½å®Œæˆåæµ‹è¯•ç»“æŸ

## ä¼˜åŒ–å†…å®¹

### 1. æµ‹è¯•é€»è¾‘ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**
- é¡ºåºç­‰å¾…æ¯ä¸ª interval æ”¶åˆ°æ¶ˆæ¯
- æ¯ä¸ª interval æœ‰ 60 ç§’è¶…æ—¶é™åˆ¶
- é¡ºåºå…³é—­æ¯ä¸ª interval çš„ç›‘å¬

**ä¼˜åŒ–åï¼š**
- **åŒæ—¶æ„å»ºæ‰€æœ‰ interval çš„ç›‘å¬**
- **å¹¶å‘ç­‰å¾…æ‰€æœ‰ interval æ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯ï¼ˆx=Trueï¼‰**
- **æ— è¶…æ—¶é™åˆ¶ï¼ŒæŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°å®Œç»“çš„Kçº¿**
- **æ”¶åˆ°å®Œç»“çš„Kçº¿åç«‹å³å…³é—­è¯¥ interval çš„ç›‘å¬**
- **æ‰€æœ‰ interval éƒ½å®Œæˆåæµ‹è¯•ç»“æŸ**

### 2. æ¶ˆæ¯å¤„ç†é€»è¾‘ä¼˜åŒ–

**å…³é”®æ”¹è¿›ï¼š**
- åªæœ‰æˆåŠŸå¤„ç†çš„å®Œç»“Kçº¿ï¼ˆx=Trueï¼‰æ‰ä¼šè§¦å‘å…³é—­ç›‘å¬
- æœªå®Œç»“çš„Kçº¿ï¼ˆx=Falseï¼‰ä¼šè¢«è·³è¿‡ï¼Œç»§ç»­ç­‰å¾…
- ç©ºæ¶ˆæ¯ä¼šè¢«è·³è¿‡ï¼Œç»§ç»­ç­‰å¾…

**ä»£ç é€»è¾‘ï¼š**
```python
# åªæœ‰æˆåŠŸå¤„ç†çš„å®Œç»“Kçº¿æ‰æ ‡è®°ä¸ºå·²æ”¶åˆ°ï¼ˆè§¦å‘å…³é—­ç›‘å¬ï¼‰
if normalized is not None:
    # è¿™æ˜¯æˆåŠŸå¤„ç†çš„å®Œç»“Kçº¿ï¼Œæ ‡è®°ä¸ºå·²æ”¶åˆ°
    event = self.message_received_events.get(key_tuple)
    if event and not event.is_set():
        event.set()
        logger.debug(
            "[æµ‹è¯•] âœ… [æ¶ˆæ¯å¤„ç†] %s %s å·²æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼Œæ ‡è®°ä¸ºå®Œæˆï¼ˆå°†å…³é—­ç›‘å¬ï¼‰",
            symbol, interval
        )
```

### 3. ç­‰å¾…é€»è¾‘ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**
```python
# é¡ºåºç­‰å¾…ï¼Œæ¯ä¸ªintervalæœ€å¤šç­‰å¾…60ç§’
for symbol in symbols:
    for interval in KLINE_INTERVALS:
        received = await test_handler.wait_for_message(symbol, interval, timeout=60)
        if received:
            await kline_manager.remove_stream(symbol, interval)
```

**ä¼˜åŒ–åï¼š**
```python
# åŒæ—¶åˆ›å»ºæ‰€æœ‰intervalçš„ç­‰å¾…ä»»åŠ¡
async def wait_and_close_interval(symbol: str, interval: str) -> Dict[str, Any]:
    """ç­‰å¾…æŒ‡å®šsymbol-intervalæ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯ï¼Œç„¶åå…³é—­ç›‘å¬ã€‚"""
    # æŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°æ¶ˆæ¯ï¼ˆä¸è®¾ç½®è¶…æ—¶ï¼Œä¸€ç›´ç­‰å¾…ï¼‰
    received = await test_handler.wait_for_message(symbol, interval, timeout=None)
    if received:
        # ç«‹å³å…³é—­è¯¥ç›‘å¬
        await kline_manager.remove_stream(symbol, interval)
    return result

# åŒæ—¶åˆ›å»ºæ‰€æœ‰ä»»åŠ¡
tasks = []
for symbol in symbols:
    for interval in KLINE_INTERVALS:
        task = asyncio.create_task(wait_and_close_interval(symbol, interval))
        tasks.append(task)

# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
results = await asyncio.gather(*tasks, return_exceptions=True)
```

### 4. wait_for_message æ–¹æ³•ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**
```python
async def wait_for_message(self, symbol: str, interval: str, timeout: int = 60) -> bool:
    """ç­‰å¾…æŒ‡å®šsymbol-intervalç»„åˆæ”¶åˆ°æ¶ˆæ¯ã€‚"""
    await asyncio.wait_for(event.wait(), timeout=timeout)
    return True
```

**ä¼˜åŒ–åï¼š**
```python
async def wait_for_message(self, symbol: str, interval: str, timeout: Optional[int] = 60) -> bool:
    """ç­‰å¾…æŒ‡å®šsymbol-intervalç»„åˆæ”¶åˆ°æ¶ˆæ¯ã€‚
    
    Args:
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå¦‚æœä¸ºNoneåˆ™ä¸€ç›´ç­‰å¾…
    """
    if timeout is None:
        # ä¸è®¾ç½®è¶…æ—¶ï¼Œä¸€ç›´ç­‰å¾…
        await event.wait()
        return True
    else:
        await asyncio.wait_for(event.wait(), timeout=timeout)
        return True
```

### 5. äº‹ä»¶è®¾ç½®é€»è¾‘ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**
```python
finally:
    # æ ‡è®°å·²æ”¶åˆ°æ¶ˆæ¯ï¼ˆæ— è®ºæ˜¯å¦æˆåŠŸå¤„ç†ï¼‰
    event = self.message_received_events.get(key_tuple)
    if event and not event.is_set():
        event.set()
```

**ä¼˜åŒ–åï¼š**
```python
# åªæœ‰æˆåŠŸå¤„ç†çš„å®Œç»“Kçº¿æ‰æ ‡è®°ä¸ºå·²æ”¶åˆ°ï¼ˆè§¦å‘å…³é—­ç›‘å¬ï¼‰
if normalized is not None:
    event = self.message_received_events.get(key_tuple)
    if event and not event.is_set():
        event.set()
        logger.debug(
            "[æµ‹è¯•] âœ… [æ¶ˆæ¯å¤„ç†] %s %s å·²æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼Œæ ‡è®°ä¸ºå®Œæˆï¼ˆå°†å…³é—­ç›‘å¬ï¼‰",
            symbol, interval
        )
```

---

## æµ‹è¯•æµç¨‹å¯¹æ¯”

### websocket_klines.py æµç¨‹

```
1. åˆ›å»ºWebSocketè¿æ¥
2. åŒæ—¶è®¢é˜…æ‰€æœ‰intervalçš„Kçº¿æµ
3. æ¯ä¸ªintervalå¹¶å‘ç­‰å¾…æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰
4. æ”¶åˆ°å®Œç»“çš„Kçº¿åç«‹å³å…³é—­è¯¥intervalçš„è®¢é˜…
5. æ‰€æœ‰intervaléƒ½å®Œæˆåå…³é—­è¿æ¥
```

### test_data_agent.py æµç¨‹ï¼ˆä¼˜åŒ–åï¼‰

```
1. æ¨¡æ‹Ÿ HTTP POST /symbols/add è¯·æ±‚
2. ä½¿ç”¨ data_agent å°è£…çš„SDKæ„å»ºæ‰€æœ‰intervalçš„ç›‘å¬
3. åŒæ—¶åˆ›å»ºæ‰€æœ‰intervalçš„ç­‰å¾…ä»»åŠ¡
4. æ¯ä¸ªintervalå¹¶å‘ç­‰å¾…æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰
5. æ”¶åˆ°å®Œç»“çš„Kçº¿åç«‹å³å…³é—­è¯¥intervalçš„ç›‘å¬
6. æ‰€æœ‰intervaléƒ½å®Œæˆåæµ‹è¯•ç»“æŸ
```

**å…³é”®åŒºåˆ«ï¼š**
- `websocket_klines.py` ç›´æ¥ä½¿ç”¨ Binance SDK
- `test_data_agent.py` ä½¿ç”¨ data_agent å°è£…çš„SDKï¼ˆ`DataAgentKlineManager`ï¼‰

---

## å…³é”®æ”¹è¿›ç‚¹

### 1. å¹¶å‘ç­‰å¾…

**ä¼˜åŒ–å‰ï¼š** é¡ºåºç­‰å¾…ï¼Œæ€»è€—æ—¶ = æ¯ä¸ªintervalçš„ç­‰å¾…æ—¶é—´ä¹‹å’Œ

**ä¼˜åŒ–åï¼š** å¹¶å‘ç­‰å¾…ï¼Œæ€»è€—æ—¶ = æœ€æ…¢çš„intervalçš„ç­‰å¾…æ—¶é—´

### 2. æ— è¶…æ—¶é™åˆ¶

**ä¼˜åŒ–å‰ï¼š** æ¯ä¸ªintervalæœ€å¤šç­‰å¾…60ç§’ï¼Œå¯èƒ½è¶…æ—¶

**ä¼˜åŒ–åï¼š** æŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼Œæ— è¶…æ—¶é™åˆ¶

### 3. åªå¤„ç†å®Œç»“çš„Kçº¿

**ä¼˜åŒ–å‰ï¼š** å¯èƒ½å¤„ç†æœªå®Œç»“çš„Kçº¿

**ä¼˜åŒ–åï¼š** åªå¤„ç†å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰ï¼Œæœªå®Œç»“çš„Kçº¿ä¼šè¢«è·³è¿‡

### 4. ç«‹å³å…³é—­

**ä¼˜åŒ–å‰ï¼š** é¡ºåºå…³é—­ï¼Œå¯èƒ½å»¶è¿Ÿ

**ä¼˜åŒ–åï¼š** æ”¶åˆ°å®Œç»“çš„Kçº¿åç«‹å³å…³é—­è¯¥intervalçš„ç›‘å¬

---

## æµ‹è¯•é…ç½®

### é»˜è®¤é…ç½®

```python
TEST_SYMBOLS = ["BTCUSDT"]  # é»˜è®¤åªæµ‹è¯•1ä¸ªsymbol

# æµ‹è¯•æ‰€æœ‰interval
KLINE_INTERVALS = ['1m', '5m', '15m', '1h', '4h', '1d', '1w']
```

### å‘½ä»¤è¡Œå‚æ•°

```bash
# æµ‹è¯•æŒ‡å®šsymbol
python -m tests.test_data_agent --symbols BTCUSDT ETHUSDT

# ä½¿ç”¨é»˜è®¤é…ç½®
python -m tests.test_data_agent
```

---

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
[æµ‹è¯•] ğŸ“¨ [æ­¥éª¤2] æ€»å…±éœ€è¦ç­‰å¾… 7 ä¸ªsymbol-intervalç»„åˆæ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯
[æµ‹è¯•] ğŸ“¨ [æ­¥éª¤2] ç­‰å¾…æ¨¡å¼: æŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰ï¼Œæ— è¶…æ—¶é™åˆ¶
[æµ‹è¯•] ğŸš€ [æ­¥éª¤2] åŒæ—¶åˆ›å»º 7 ä¸ªç­‰å¾…ä»»åŠ¡...
[æµ‹è¯•] âœ… [æ­¥éª¤2] æ‰€æœ‰ 7 ä¸ªç­‰å¾…ä»»åŠ¡å·²åˆ›å»ºï¼Œå¼€å§‹å¹¶å‘ç­‰å¾…...

[æµ‹è¯•] ğŸ“¨ [æ­¥éª¤2] [BTCUSDT 1m] å¼€å§‹ç­‰å¾…å®Œç»“çš„Kçº¿æ¶ˆæ¯ï¼ˆæŒç»­ç­‰å¾…ï¼Œæ— è¶…æ—¶ï¼‰...
[æµ‹è¯•] ğŸ“¨ [æ­¥éª¤2] [BTCUSDT 5m] å¼€å§‹ç­‰å¾…å®Œç»“çš„Kçº¿æ¶ˆæ¯ï¼ˆæŒç»­ç­‰å¾…ï¼Œæ— è¶…æ—¶ï¼‰...
...

[æµ‹è¯•] âœ… [æ­¥éª¤2] [BTCUSDT 1m] å·²æ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯
[æµ‹è¯•] ğŸ”Œ [æ­¥éª¤2] [BTCUSDT 1m] å¼€å§‹å…³é—­ç›‘å¬...
[æµ‹è¯•] âœ… [æ­¥éª¤2] [BTCUSDT 1m] ç›‘å¬å·²å…³é—­ (è€—æ—¶: 0.887s)

[æµ‹è¯•] âœ… [æ­¥éª¤2] [BTCUSDT 5m] å·²æ”¶åˆ°å®Œç»“çš„Kçº¿æ¶ˆæ¯
[æµ‹è¯•] ğŸ”Œ [æ­¥éª¤2] [BTCUSDT 5m] å¼€å§‹å…³é—­ç›‘å¬...
...

[æµ‹è¯•] âœ… [æ­¥éª¤2] æ‰€æœ‰ç›‘å¬å¤„ç†å®Œæˆ
[æµ‹è¯•] ğŸ“Š [æ­¥éª¤2] ç»“æœç»Ÿè®¡:
[æµ‹è¯•]   - æ€»ä»»åŠ¡æ•°: 7
[æµ‹è¯•]   - å®Œæˆæ•°: 7
[æµ‹è¯•]   - æˆåŠŸæ•°: 7
[æµ‹è¯•]   - å¤±è´¥æ•°: 0
```

---

## ä¸ websocket_klines.py çš„å¯¹æ¯”

| ç‰¹æ€§ | websocket_klines.py | test_data_agent.py |
|------|---------------------|-------------------|
| SDKä½¿ç”¨ | ç›´æ¥ä½¿ç”¨ Binance SDK | ä½¿ç”¨ data_agent å°è£…çš„SDK |
| è¿æ¥æ„å»º | ç›´æ¥åˆ›å»ºè¿æ¥ | é€šè¿‡ `add_symbol_streams()` æ„å»º |
| ç­‰å¾…æ–¹å¼ | å¹¶å‘ç­‰å¾… | å¹¶å‘ç­‰å¾… |
| è¶…æ—¶é™åˆ¶ | æ— è¶…æ—¶ | æ— è¶…æ—¶ |
| æ¶ˆæ¯è¿‡æ»¤ | åªå¤„ç†å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰ | åªå¤„ç†å®Œç»“çš„Kçº¿ï¼ˆx=Trueï¼‰ |
| å…³é—­æ—¶æœº | æ”¶åˆ°å®Œç»“Kçº¿åç«‹å³å…³é—­ | æ”¶åˆ°å®Œç»“Kçº¿åç«‹å³å…³é—­ |
| æµ‹è¯•ç›®çš„ | æµ‹è¯•SDKåŠŸèƒ½ | æµ‹è¯• data_agent å°è£…çš„åŠŸèƒ½ |

---

## æ³¨æ„äº‹é¡¹

1. **åªå¤„ç†å®Œç»“çš„Kçº¿**ï¼šåªæœ‰ `x=True` çš„Kçº¿æ‰ä¼šè§¦å‘å…³é—­ç›‘å¬ï¼Œæœªå®Œç»“çš„Kçº¿ä¼šè¢«è·³è¿‡ã€‚

2. **æ— è¶…æ—¶é™åˆ¶**ï¼šæµ‹è¯•ä¼šæŒç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼Œä¸è®¾ç½®è¶…æ—¶ã€‚å¦‚æœæŸä¸ªintervalé•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°å®Œç»“çš„Kçº¿ï¼Œæµ‹è¯•ä¼šä¸€ç›´ç­‰å¾…ã€‚

3. **å¹¶å‘ç­‰å¾…**ï¼šæ‰€æœ‰intervalåŒæ—¶ç­‰å¾…ï¼Œä¸ä¼šç›¸äº’é˜»å¡ã€‚

4. **ç«‹å³å…³é—­**ï¼šæ”¶åˆ°å®Œç»“çš„Kçº¿åç«‹å³å…³é—­è¯¥intervalçš„ç›‘å¬ï¼Œä¸ä¼šç­‰å¾…å…¶ä»–intervalã€‚

5. **ä½¿ç”¨ data_agent å°è£…**ï¼šæµ‹è¯•ä½¿ç”¨çš„æ˜¯ `DataAgentKlineManager` å°è£…çš„SDKï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ Binance SDKã€‚

---

## ç›¸å…³æ–‡ä»¶

- `tests/test_data_agent.py`: ä¼˜åŒ–åçš„æµ‹è¯•ä»£ç 
- `tests/websocket_klines.py`: å‚è€ƒçš„æµ‹è¯•ä»£ç ï¼ˆç›´æ¥ä½¿ç”¨SDKï¼‰
- `data/data_agent.py`: data_agent å°è£…çš„SDKä»£ç 

