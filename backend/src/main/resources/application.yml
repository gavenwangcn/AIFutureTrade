spring:
  application:
    name: backend
  profiles:
    active: dev
  # 禁用调试模式（这会禁用自动配置条件评估报告）
  main:
    banner-mode: console
  # 修复 Springfox 与 Spring Boot 2.7+ 的兼容性问题
  # Spring Boot 2.7+ 默认使用 PathPatternParser，但 Springfox 2.9.2 不支持
  # 需要强制使用 AntPathMatcher
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
  
  # 数据库配置（可通过环境变量覆盖）
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:mysql://154.89.148.172:32123/aifuturetrade?useSSL=false&serverTimezone=UTC&characterEncoding=utf8}
    username: ${SPRING_DATASOURCE_USERNAME:aifuturetrade}
    password: ${SPRING_DATASOURCE_PASSWORD:aifuturetrade123}
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource
    # Druid连接池配置（优化连接泄漏检测）
    druid:
      # 初始化连接池大小
      initial-size: 5
      # 最小连接池数量
      min-idle: 5
      # 最大连接池数量
      max-active: 20
      # 获取连接超时时间
      max-wait: 10000  # 降低等待时间
      # 连接最小空闲时间
      min-evictable-idle-time-millis: 300000  # 5分钟
      # 连接最大空闲时间
      max-evictable-idle-time-millis: 600000  # 10分钟
      # 间隔多久进行一次检测，检测需要关闭的空闲连接
      time-between-eviction-runs-millis: 60000
      # 检查连接有效性的SQL语句
      validation-query: SELECT 1
      # 检测连接是否有效的超时时间
      validation-query-timeout: 3  # 降低验证超时
      # 获取连接时是否验证连接有效性
      test-on-borrow: false
      # 归还连接时是否验证连接有效性
      test-on-return: false
      # 空闲时是否验证连接有效性
      test-while-idle: true
      # 配置监控统计拦截的filters
      filters: stat,wall
      # 连接池名称
      pool-name: DruidCP
      # 连接泄漏检测和回收（默认禁用，避免生产环境警告）
      # 开发环境可以在 application-dev.yml 中启用此功能来检测连接泄漏
      remove-abandoned: false  # 默认禁用，开发环境可在 application-dev.yml 中启用
      # remove-abandoned-timeout-millis: 300000  # 已禁用，无需配置
      # log-abandoned: true  # 已禁用，无需配置
      # 启用监控统计
      use-global-data-source-stat: true
      # 连接超时配置
      connect-timeout: 5000
      socket-timeout: 30000
      keep-alive: true
      phy-timeout-millis: 28800000  # 8小时
  
  # MyBatis配置
  mybatis-plus:
    mapper-locations: classpath:mybatis/*.xml
    type-aliases-package: com.aifuturetrade.dao.entity
    configuration:
      map-underscore-to-camel-case: true
      cache-enabled: false
      call-setters-on-nulls: true
      # 使用SLF4J日志实现，这样可以通过logback控制日志级别
      log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    global-config:
      db-config:
        id-type: auto
        logic-delete-field: deleted
        logic-delete-value: 1
        logic-not-delete-value: 0

# 服务器配置
server:
  port: ${SERVER_PORT:5002}  # 默认使用5002端口，可通过环境变量SERVER_PORT覆盖
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    uri-encoding: UTF-8
    max-threads: 200
    min-spare-threads: 10
    connection-timeout: 30000

# 日志配置
logging:
  level:
    root: info
    com.aifuturetrade: info
    # 禁用 Spring Boot 自动配置条件评估报告日志
    org.springframework.boot.autoconfigure: WARN
    org.springframework.boot.autoconfigure.condition: WARN
    # 降低HTTP解析错误日志级别（减少攻击扫描产生的日志噪音）
    org.apache.coyote.http11: WARN
    org.apache.tomcat: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/backend.log
    max-size: 10MB
    max-history: 7

# Binance API配置（可通过环境变量覆盖）
binance:
    api-key: ${BINANCE_API_KEY:LBtjhBgX1RCksNJDdOoJPeDD30Z70YIGHHH9DrqjIDDkK7xcPRQcgydPxGRr6MN1}
    secret-key: ${BINANCE_SECRET_KEY:55arJnwlytDflHv151UpHN1s32ACnJZEs86mbc79wGyeuSUJNHTDPN7jEgBbqO6I}
    private-key-path: 
    private-key-pass: 
    base-url: https://api.binance.com
    testnet: false
    quote-asset: USDT
    # 连接超时时间（毫秒）
    connect-timeout: 10000
    # 读取超时时间（毫秒）
    read-timeout: 50000
    # 重试次数
    retries: 3
    # 重试间隔时间（毫秒）
    backoff: 200
    # 是否启用压缩
    compression: true
  
# 应用配置（可通过环境变量覆盖）
app:
  auto-trading: ${APP_AUTO_TRADING:true}

# Socket.IO 配置（可通过环境变量覆盖）
socketio:
  port: ${SOCKETIO_PORT:5003}  # Socket.IO 服务器端口（独立于 HTTP 服务器端口）
  trade-fee-rate: ${APP_TRADE_FEE_RATE:0.001}
  leaderboard-refresh: 10  # 涨跌幅榜刷新间隔（秒）
  trading-interval: 3600  # 交易执行间隔（秒）
  trades-query-limit: 10  # 后端查询的交易记录数量
  trades-display-count: 5  # 前端显示的交易记录数量

# Trade服务配置（可通过环境变量覆盖）
trade:
  base-url: ${TRADE_SERVICE_URL:http://154.89.148.172:5000}  # Trade服务基础URL，默认 http://trade:5000
  connect-timeout: 10000  # 连接超时时间（毫秒）
  read-timeout: 30000  # 读取超时时间（毫秒）
  retries: 3  # 重试次数
  backoff: 200  # 重试间隔时间（毫秒）
  # 市场数据配置
  market-prices-refresh: 10  # 市场行情价格前端轮询刷新间隔（秒）
  futures-top-gainers-limit: 5  # 涨幅榜返回的交易对数量限制
  futures-kline-limit: 300  # K线数据获取的最大数量限制
  # AI交易决策配置
  prompt-market-symbol-limit: 3  # 每次调用AI模型时处理的市场合约数量
  buy-decision-thread-count: 1  # 买入决策API调用的并发线程数
  sell-decision-thread-count: 1  # 卖出决策API调用的并发线程数
  # 异步服务配置
  kline-sync-check-interval: 10  # K线WebSocket巡检间隔（秒）
  kline-cleanup-cron: "0 */1 * * *"  # K线清理Cron表达式，默认每1小时执行一次
  kline-cleanup-retention-days: 14  # K线数据保留天数，默认14天
  price-refresh-cron: "*/5 * * * *"  # 价格刷新Cron表达式，默认每5分钟执行一次
  price-refresh-max-per-minute: 1000  # 每分钟最多刷新的symbol数量
  market-symbol-offline-cron: "*/30 * * * *"  # 市场Symbol下线Cron表达式，默认每30分钟执行一次
  market-symbol-retention-minutes: 30  # Ticker数据保留分钟数，默认30分钟

# Swagger配置
swagger:
  enabled: true
  title: AI Future Trade API
  description: AI Future Trade Java Backend API Documentation
  version: 1.0.0
  base-package: com.aifuturetrade.controller
  contact:
    name: AI Future Trade Team
    email: contact@aifuturetrade.com
