spring:
  application:
    name: backend
  profiles:
    active: dev
  # 禁用调试模式（这会禁用自动配置条件评估报告）
  main:
    banner-mode: console
  # SpringDoc OpenAPI 配置（替代 Springfox Swagger，兼容 Spring Boot 3.x）
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
  
  # 数据库配置（可通过环境变量覆盖）
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:mysql://154.89.148.172:32123/aifuturetrade?useSSL=false&serverTimezone=UTC&characterEncoding=utf8}
    username: ${SPRING_DATASOURCE_USERNAME:aifuturetrade}
    password: ${SPRING_DATASOURCE_PASSWORD:aifuturetrade123}
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource
    # Druid连接池配置（优化连接泄漏检测）
    druid:
      # 初始化连接池大小
      initial-size: 5
      # 最小连接池数量
      min-idle: 5
      # 最大连接池数量
      max-active: 20
      # 获取连接超时时间
      max-wait: 10000  # 降低等待时间
      # 连接最小空闲时间
      min-evictable-idle-time-millis: 300000  # 5分钟
      # 连接最大空闲时间
      max-evictable-idle-time-millis: 600000  # 10分钟
      # 间隔多久进行一次检测，检测需要关闭的空闲连接
      time-between-eviction-runs-millis: 60000
      # 检查连接有效性的SQL语句
      validation-query: SELECT 1
      # 检测连接是否有效的超时时间
      validation-query-timeout: 3  # 降低验证超时
      # 获取连接时是否验证连接有效性
      test-on-borrow: false
      # 归还连接时是否验证连接有效性
      test-on-return: false
      # 空闲时是否验证连接有效性
      test-while-idle: true
      # 配置监控统计拦截的filters
      filters: stat,wall
      # 连接池名称
      pool-name: DruidCP
      # 连接泄漏检测和回收（默认禁用，避免生产环境警告）
      # 开发环境可以在 application-dev.yml 中启用此功能来检测连接泄漏
      remove-abandoned: false  # 默认禁用，开发环境可在 application-dev.yml 中启用
      # remove-abandoned-timeout-millis: 300000  # 已禁用，无需配置
      # log-abandoned: true  # 已禁用，无需配置
      # 启用监控统计
      use-global-data-source-stat: true
      # 连接超时配置
      connect-timeout: 5000
      socket-timeout: 30000
      keep-alive: true
      phy-timeout-millis: 28800000  # 8小时
  
  # MyBatis配置
  mybatis-plus:
    mapper-locations: classpath:mybatis/*.xml
    type-aliases-package: com.aifuturetrade.dao.entity
    configuration:
      map-underscore-to-camel-case: true
      cache-enabled: false
      call-setters-on-nulls: true
      # 使用SLF4J日志实现，这样可以通过logback控制日志级别
      log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    global-config:
      db-config:
        id-type: auto
        logic-delete-field: deleted
        logic-delete-value: 1
        logic-not-delete-value: 0

# 服务器配置（Undertow异步IO高性能优化）
server:
  port: ${SERVER_PORT:5002}  # 默认使用5002端口，可通过环境变量SERVER_PORT覆盖
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  undertow:
    # Undertow异步IO配置（高性能）
    # IO线程数（用于处理IO操作，通常设置为CPU核心数）
    io-threads: ${UNDERTOW_IO_THREADS:4}
    # Worker线程数（用于处理业务逻辑，通常设置为CPU核心数 * 8）
    worker-threads: ${UNDERTOW_WORKER_THREADS:64}
    # 每个Worker线程的队列大小
    worker-connections: ${UNDERTOW_WORKER_CONNECTIONS:10000}
    # 最大连接数
    max-connections: ${UNDERTOW_MAX_CONNECTIONS:10000}
    # 连接超时时间（毫秒）
    connection-timeout: ${UNDERTOW_CONNECTION_TIMEOUT:20000}
    # 是否启用HTTP/2
    http2-enabled: true
    # 是否启用直接内存分配（提升性能）
    direct-buffers: true
    # 缓冲区大小（字节）
    buffer-size: ${UNDERTOW_BUFFER_SIZE:16384}
    # 是否启用压缩
    compression-enabled: true
    # 压缩级别（1-9，9为最高压缩率）
    compression-level: 6
    # 最小压缩大小（字节）
    compression-min-size: 1024
    # 可压缩的MIME类型
    compressable-mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript
    # 最大HTTP POST大小（字节，10MB）
    max-http-post-size: 10485760
    # 是否启用统计信息
    statistics-enabled: false  # 生产环境禁用以提升性能

# 日志配置
logging:
  level:
    root: info
    com.aifuturetrade: info
    # 禁用 Spring Boot 自动配置条件评估报告日志
    org.springframework.boot.autoconfigure: WARN
    org.springframework.boot.autoconfigure.condition: WARN
    # 降低HTTP解析错误日志级别（减少攻击扫描产生的日志噪音）
    org.apache.coyote.http11: WARN
    org.apache.tomcat: WARN
    # Undertow日志级别
    io.undertow: WARN
    org.xnio: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/backend.log
    max-size: 10MB
    max-history: 7

# Binance API配置（可通过环境变量覆盖）
binance:
    api-key: ${BINANCE_API_KEY:LBtjhBgX1RCksNJDdOoJPeDD30Z70YIGHHH9DrqjIDDkK7xcPRQcgydPxGRr6MN1}
    secret-key: ${BINANCE_SECRET_KEY:55arJnwlytDflHv151UpHN1s32ACnJZEs86mbc79wGyeuSUJNHTDPN7jEgBbqO6I}
    private-key-path: 
    private-key-pass: 
    base-url: https://api.binance.com
    testnet: false
    quote-asset: USDT
    # 连接超时时间（毫秒）- 增加到30秒，减少连接超时错误
    connect-timeout: 30000
    # 读取超时时间（毫秒）- 增加到60秒，减少读取超时错误
    read-timeout: 60000
    # 重试次数
    retries: 3
    # 重试间隔时间（毫秒）
    backoff: 200
    # 是否启用压缩
    compression: true
  
# 应用配置（可通过环境变量覆盖）
app:
  auto-trading: ${APP_AUTO_TRADING:true}
  # 一键卖出交易模式：'test' 使用测试接口（默认，不会真实成交），'real' 使用真实交易接口
  sell-position-trade-mode: ${APP_SELL_POSITION_TRADE_MODE:test}

# Socket.IO 配置（可通过环境变量覆盖）
socketio:
  port: ${SOCKETIO_PORT:5003}  # Socket.IO 服务器端口（独立于 HTTP 服务器端口）
  trade-fee-rate: ${APP_TRADE_FEE_RATE:0.001}
  leaderboard-refresh: 10  # 涨跌幅榜刷新间隔（秒）
  trading-interval: 3600  # 交易执行间隔（秒）
  trades-query-limit: 10  # 后端查询的交易记录数量
  trades-display-count: 5  # 前端显示的交易记录数量

# Trade服务配置（可通过环境变量覆盖）
trade:
  base-url: ${TRADE_SERVICE_URL:http://154.89.148.172:5000}  # Trade服务基础URL，默认 http://trade:5000
  connect-timeout: 10000  # 连接超时时间（毫秒）
  read-timeout: 30000  # 读取超时时间（毫秒）
  retries: 3  # 重试次数
  backoff: 200  # 重试间隔时间（毫秒）
  # 市场数据配置
  market-prices-refresh: 10  # 市场行情价格前端轮询刷新间隔（秒）
  futures-top-gainers-limit: 5  # 涨幅榜返回的交易对数量限制
  futures-kline-limit: 300  # K线数据获取的最大数量限制
  # AI交易决策配置
  prompt-market-symbol-limit: 3  # 每次调用AI模型时处理的市场合约数量
  buy-decision-thread-count: 1  # 买入决策API调用的并发线程数
  sell-decision-thread-count: 1  # 卖出决策API调用的并发线程数
  # 异步服务配置
  kline-sync-check-interval: 10  # K线WebSocket巡检间隔（秒）
  kline-cleanup-cron: "0 */1 * * *"  # K线清理Cron表达式，每1小时执行一次
  kline-cleanup-retention-days: 14  # K线数据保留天数
  # 价格刷新服务配置（格式：秒 分 时 日 月 周）
  price-refresh-cron: "0 */5 * * * *"  # 每5分钟执行一次
  price-refresh-max-per-minute: 1000  # 每分钟最多刷新的symbol数量
  # 市场Symbol下线服务配置（格式：秒 分 时 日 月 周）
  market-symbol-offline-cron: "0 */30 * * * *"  # 每30分钟执行一次
  market-symbol-retention-minutes: 30  # Ticker数据保留分钟数

# Docker配置（可通过环境变量覆盖）
# 注意：
#   - Windows系统: 使用 tcp://localhost:2375（需要在Docker Desktop中启用TCP端口）
#   - Linux/Mac系统: 使用 unix:///var/run/docker.sock（默认）
#   - 如果backend在Docker容器中运行，需要挂载 /var/run/docker.sock 到容器内
#   - 代码会自动检测操作系统并选择默认连接方式
docker:
  host: ${DOCKER_HOST:unix:///var/run/docker.sock}  # Docker主机地址，容器内使用Unix socket
  container-name: ${DOCKER_CONTAINER_NAME:aifuturetrade-trade}  # 交易日志容器名称
  network: ${DOCKER_NETWORK:aifuturetrade-network}  # Docker网络名称
  image:
    buy: ${DOCKER_IMAGE_BUY:aifuturetrade-model-buy}  # 模型买入容器镜像名称
    sell: ${DOCKER_IMAGE_SELL:aifuturetrade-model-sell}  # 模型卖出容器镜像名称

# MySQL配置（用于传递给模型容器）
mysql:
  host: ${MYSQL_HOST:154.89.148.172}  # 默认数据库地址：154.89.148.172
  port: ${MYSQL_PORT:32123}
  user: ${MYSQL_USER:aifuturetrade}
  password: ${MYSQL_PASSWORD:aifuturetrade123}
  database: ${MYSQL_DATABASE:aifuturetrade}

# Swagger配置
swagger:
  enabled: true
  title: AI Future Trade API
  description: AI Future Trade Java Backend API Documentation
  version: 1.0.0
  base-package: com.aifuturetrade.controller
  contact:
    name: AI Future Trade Team
    email: contact@aifuturetrade.com
