# ============ K线数据测试Dockerfile ============
# 用于构建和运行K线数据测试的Docker镜像
# 可以在没有JDK的服务器上运行测试

# 多阶段构建：第一阶段构建JAR文件
FROM maven:3.8.6-openjdk-11-slim AS builder

WORKDIR /app

# 复制pom.xml并下载依赖
COPY pom.xml .
RUN mvn dependency:go-offline -B -DskipTests || \
    mvn dependency:resolve -B -DskipTests

# 复制源代码
COPY src ./src

# 构建应用（包含测试类）
RUN mvn clean compile -B -U

# 创建测试JAR文件（包含所有依赖）
RUN mvn package -B -DskipTests || \
    (echo "Build failed, showing error details..." && \
     mvn package -DskipTests && \
     exit 1)

# 第二阶段：运行阶段
FROM adoptopenjdk:11-jre-hotspot

WORKDIR /app

# 从构建阶段复制JAR文件
COPY --from=builder /app/target/java-backend-1.0.0.jar app.jar

# 设置默认JVM参数
ENV JAVA_OPTS="-Xms256m -Xmx512m"

# 创建启动脚本
RUN echo '#!/bin/sh\njava $JAVA_OPTS -cp app.jar com.aifuturetrade.test.KlineCandlestickDataTest "$@"' > /app/run-test.sh && \
    chmod +x /app/run-test.sh

# 默认执行测试
ENTRYPOINT ["/app/run-test.sh"]

