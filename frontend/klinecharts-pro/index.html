<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K线分析图</title>
  <!-- 引入CSS -->
  <link rel="stylesheet" href="./node_modules/@klinecharts/pro/dist/klinecharts-pro.css"/>
</head>
<body>
  <!-- 创建容器 -->
  <div id="container" style="width: 100vw; height: 100vh;"></div>

  <!-- 引入klinecharts库 -->
  <script src="./node_modules/klinecharts/dist/umd/klinecharts.js"></script>
  <script src="./node_modules/@klinecharts/pro/dist/klinecharts-pro.umd.js"></script>
  <script>
    // 创建AkshareDatafeed类
    class AkshareDatafeed {
      async getSymbols() {
        try {
          const response = await fetch('http://localhost:8000/api/symbols');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data.map(symbol => ({
            ticker: symbol.ticker,
            name: symbol.name,
            exchange: symbol.exchange,
            type: symbol.type,
            priceCurrency: symbol.priceCurrency
          }));
        } catch (error) {
          console.error('获取股票代码列表失败:', error);
          return [];
        }
      }

      // 添加searchSymbols方法
      async searchSymbols(searchTerm) {
        console.log('AkshareDatafeed.searchSymbols called', { searchTerm });
        try {
          // 调用getSymbols获取所有符号
          const allSymbols = await this.getSymbols();
          // 根据searchTerm过滤符号
          return allSymbols.filter(symbol => 
            symbol.ticker.includes(searchTerm) || 
            (symbol.name && symbol.name.includes(searchTerm)) ||
            (symbol.shortName && symbol.shortName.includes(searchTerm))
          );
        } catch (error) {
          console.error('搜索股票代码失败:', error);
          return [];
        }
      }

      async getHistoryKLineData({ ticker: symbol, type }, period) {
        console.log('AkshareDatafeed.getHistoryKLineData called', { symbol, type, period });
        try {
          // 将KLineChart Pro的周期格式转换为akshare API的格式
          let apiPeriod = 'daily';
          switch(period.timespan) {
              case 'minute':
                  apiPeriod = period.multiplier.toString(); // 使用具体的分钟数据
                  break;
              case 'hour':
                  apiPeriod = (period.multiplier * 60).toString(); // 转换为分钟
                  break;
              case 'day':
                  apiPeriod = 'daily';
                  break;
              case 'week':
                  apiPeriod = 'weekly';
                  break;
              case 'month':
                  apiPeriod = 'monthly';
                  break;
          }
                            
          // 构建K线数据请求参数
          const requestData = {
            symbol: symbol,
            period: apiPeriod,
            type: type 
          };
          
          console.log('请求数据:', { requestData });
          
          // 对于2H和4H周期，需要获取1H数据后进行聚合
          if (period.timespan === 'hour' && (period.multiplier === 2 || period.multiplier === 4)) {
            // 构建1H数据请求参数
            const hourlyRequestData = {
              symbol: symbol,
              period: '60', // 1H数据
              type: type
            };
            
            // 获取1H数据
            const hourlyResponse = await fetch('http://localhost:8000/api/history_kline', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(hourlyRequestData)
            });
            
            if (!hourlyResponse.ok) {
              const errorText = await hourlyResponse.text();
              console.error('HTTP错误详情:', errorText);
              throw new Error(`HTTP error! status: ${hourlyResponse.status}, details: ${errorText}`);
            }
            
            const hourlyResult = await hourlyResponse.json();
            // 检查hourlyResult是否有data属性
            if (!hourlyResult || !hourlyResult.data || !Array.isArray(hourlyResult.data)) {
              console.error('响应数据格式不正确:', hourlyResult);
              throw new Error('响应数据格式不正确');
            }
            
            const hourlyData = hourlyResult.data.map(item => ({
              timestamp: item.timestamp,
              open: item.open,
              high: item.high,
              low: item.low,
              close: item.close,
              volume: item.volume
            }));
            
            // 聚合数据
            const aggregatedData = [];
            const multiplier = period.multiplier;
            
            for (let i = 0; i < hourlyData.length; i += multiplier) {
              const chunk = hourlyData.slice(i, i + multiplier);
              if (chunk.length > 0) {
                const aggregated = {
                  timestamp: chunk[0].timestamp,
                  open: chunk[0].open,
                  high: Math.max(...chunk.map(item => item.high)),
                  low: Math.min(...chunk.map(item => item.low)),
                  close: chunk[chunk.length - 1].close,
                  volume: chunk.reduce((sum, item) => sum + item.volume, 0)
                };
                aggregatedData.push(aggregated);
              }
            }
            
            return aggregatedData;
          }
          
          const response = await fetch('http://localhost:8000/api/history_kline', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
          });
          
          console.log('响应状态:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('HTTP错误详情:', errorText);
            throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
          }
          
          const result = await response.json();
          console.log('响应数据:', result);
          return result.data.map(item => ({
            timestamp: item.timestamp,
            open: item.open,
            high: item.high,
            low: item.low,
            close: item.close,
            volume: item.volume
          }));
        } catch (error) {
          console.error('获取历史K线数据失败:', error);
          return [];
        }
      }

      // subscribe方法
      subscribe(symbol, period, callback) {
        // 这里可以实现订阅逻辑，例如使用WebSocket
        // 为了简化，我们直接调用getHistoryKLineData并返回数据
        // console.log('AkshareDatafeed.subscribe called', { symbol, period });
        this.getHistoryKLineData(symbol, period).then(data => {
          // 检查返回的数据是否有效
          if (data && Array.isArray(data)) {
            callback(data);
          } else {
            console.warn('订阅数据为空:', { symbol, period, data });
            // 即使数据为空也调用callback，传入空数组
            callback([]);
          }
        }).catch(error => {
           console.error('订阅数据失败:', error);
          // 在出错时也调用callback，传入空数组
          callback([]);
        });
      }

      // unsubscribe方法
      unsubscribe(symbol, period) {
        // console.log('AkshareDatafeed.unsubscribe called')
        // 在这个简单的实现中，我们不需要做任何事情
        // 如果使用WebSocket，这里可以关闭连接
      }
    }

    // 创建实例
    const chart = new klinechartspro.KLineChartPro({
      container: document.getElementById('container'),
      // 初始化标的信息
      symbol: {
        exchange: 'SSE',
        market: 'SSE',
        name: '上证指数',
        shortName: '上证指数',
        ticker: '000001.SH',
        priceCurrency: 'cny',
        type: 'index',
      },
      // 初始化周期
      period: { multiplier: 1, timespan: 'day', text: '1d' },
      // 添加周期选项
      periods: [
          { multiplier: 1, timespan: 'minute', text: '1m' },
          { multiplier: 5, timespan: 'minute', text: '5m' },
          { multiplier: 15, timespan: 'minute', text: '15m' },
          { multiplier: 30, timespan: 'minute', text: '30m' }, 
          { multiplier: 1, timespan: 'hour', text: '1H' },
          { multiplier: 2, timespan: 'hour', text: '2H' },
          { multiplier: 1, timespan: 'day', text: '1D' },
          { multiplier: 1, timespan: 'week', text: '1W' },
          { multiplier: 1, timespan: 'month', text: '1M' }
      ],
      // 使用自定义的AkshareDatafeed
      datafeed: new AkshareDatafeed()
    });
  </script>
</body>
</html>