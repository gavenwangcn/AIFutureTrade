# ==============================================================================
# MySQL 8.0 高性能配置文件
# ==============================================================================
# 适用于高频交易数据存储场景
# 根据服务器内存大小调整相关参数
# ==============================================================================

[mysqld]
# ============================================================================
# 基础配置
# ============================================================================
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
default-time-zone='+00:00'
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

# ============================================================================
# 认证插件配置（解决 MySQL 8.0 认证问题）
# ============================================================================
# 设置默认认证插件为 mysql_native_password（兼容 PyMySQL）
# 注意：此配置只影响新创建的用户，已存在的用户需要手动修改
default-authentication-plugin=mysql_native_password

# ============================================================================
# 网络绑定配置（允许从 localhost 和外部连接）
# ============================================================================
# 绑定到所有网络接口（0.0.0.0），允许从 localhost、127.0.0.1 和外部IP连接
# 注意：此配置确保可以通过 127.0.0.1 和 localhost 连接
bind-address=0.0.0.0

# ============================================================================
# 连接配置
# ============================================================================
# 最大连接数（根据应用连接池配置，建议设置为应用最大连接数的1.5-2倍）
max_connections=100
# 最大错误连接数（防止恶意连接）
max_connect_errors=10000
# 连接超时时间（秒）
connect_timeout=10
# 等待连接超时时间（秒）
wait_timeout=600
# 交互式连接超时时间（秒）
interactive_timeout=600
# 最大数据包大小（64MB，适合大数据插入）
max_allowed_packet=64M

# ============================================================================
# 内存配置（根据服务器内存调整）
# ============================================================================
# 假设服务器有4GB内存，根据实际情况调整
# 如果服务器内存更大，可以相应增加这些值

# InnoDB缓冲池大小（建议设置为服务器内存的50-70%）
# 4GB服务器：设置为2GB
# 8GB服务器：设置为4-5GB
# 16GB服务器：设置为8-10GB
innodb_buffer_pool_size=2G

# InnoDB缓冲池实例数（提高并发性能）
# 建议：缓冲池大小 < 1GB 时设为1，>= 1GB 时设为8
innodb_buffer_pool_instances=8

# 查询缓存（MySQL 8.0已移除，保留注释）
# query_cache_size=0
# query_cache_type=0

# 临时表内存大小（适合大数据量查询）
tmp_table_size=256M
max_heap_table_size=256M

# 排序缓冲区大小
sort_buffer_size=4M
read_buffer_size=2M
read_rnd_buffer_size=4M
join_buffer_size=4M

# ============================================================================
# InnoDB存储引擎配置（高频写入优化）
# ============================================================================
# 使用独立表空间（便于管理）
innodb_file_per_table=1

# InnoDB日志文件大小（提高写入性能）
# 建议：256MB-2GB，根据写入量调整
innodb_log_file_size=512M
innodb_log_buffer_size=64M

# InnoDB刷新策略（平衡性能和数据安全）
# 0: 每秒刷新（最安全，性能较低）
# 1: 每次事务提交刷新（推荐，平衡性能和安全）
# 2: 每次事务提交写入OS缓存，每秒刷新（性能最高，风险较高）
innodb_flush_log_at_trx_commit=1

# InnoDB刷新方法（使用O_DIRECT提高性能）
innodb_flush_method=O_DIRECT

# InnoDB IO线程数（提高并发IO性能）
innodb_read_io_threads=4
innodb_write_io_threads=4

# InnoDB并发线程数（提高并发处理能力）
innodb_thread_concurrency=0  # 0表示不限制

# InnoDB自适应哈希索引（提高查询性能）
innodb_adaptive_hash_index=ON

# InnoDB死锁检测（开启以快速发现死锁）
innodb_deadlock_detect=ON

# InnoDB锁等待超时（秒）
innodb_lock_wait_timeout=50

# InnoDB自动扩展表空间
innodb_autoextend_increment=64

# ============================================================================
# 日志配置
# ============================================================================
# 慢查询日志（记录执行时间超过long_query_time的查询）
slow_query_log=1
long_query_time=2  # 2秒
slow_query_log_file=/var/log/mysql/slow-query.log

# 通用查询日志（生产环境建议关闭以节省IO）
general_log=0

# 二进制日志（用于主从复制和数据恢复）
log_bin=/var/log/mysql/mysql-bin.log
binlog_format=ROW
binlog_expire_logs_seconds=604800  # 7天
max_binlog_size=500M

# 错误日志
log_error=/var/log/mysql/error.log

# ============================================================================
# 表结构优化
# ============================================================================
# 表打开缓存（提高表访问性能）
table_open_cache=4000
table_definition_cache=2000

# ============================================================================
# 其他性能优化
# ============================================================================
# 禁用DNS反向解析（提高连接速度）
skip-name-resolve

# 禁用符号链接（提高安全性）
symbolic-links=0

# 最大数据包大小
max_allowed_packet=64M

# 线程缓存（减少线程创建开销）
thread_cache_size=50

# ============================================================================
# 字符集配置
# ============================================================================
[client]
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4

