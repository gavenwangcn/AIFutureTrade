# ==============================================================================
# Docker Compose 配置文件
# ==============================================================================
# 注意：version字段在新版本Docker Compose中已废弃，但保留以兼容旧版本
# 如果看到警告，可以安全地忽略或移除version字段
# ==============================================================================

services:
  # ============================================================================
  # 后端服务（Python Flask API）
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-backend
    ports:
      - "5002:5002"  # 后端API端口
    volumes:
      - ./data:/app/data
    environment:
      # 基础配置
      - DATABASE_PATH=/app/data/trading_bot.db
      - USE_GUNICORN=true
      - FLASK_ENV=production
      # Gunicorn配置
      - GUNICORN_WORKERS=${GUNICORN_WORKERS}
      - GUNICORN_WORKER_CLASS=${GUNICORN_WORKER_CLASS}
      - GUNICORN_WORKER_CONNECTIONS=${GUNICORN_WORKER_CONNECTIONS}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT}
      - GUNICORN_KEEPALIVE=${GUNICORN_KEEPALIVE}
      - GUNICORN_MAX_REQUESTS=${GUNICORN_MAX_REQUESTS}
      # ClickHouse配置
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_TICKER_TABLE=${CLICKHOUSE_MARKET_TICKER_TABLE}
      - CLICKHOUSE_LEADERBOARD_TABLE=${CLICKHOUSE_LEADERBOARD_TABLE}
      - CLICKHOUSE_LEADERBOARD_SYNC_INTERVAL=${CLICKHOUSE_LEADERBOARD_SYNC_INTERVAL}
      - CLICKHOUSE_LEADERBOARD_TIME_WINDOW=${CLICKHOUSE_LEADERBOARD_TIME_WINDOW}
      - CLICKHOUSE_LEADERBOARD_TOP_N=${CLICKHOUSE_LEADERBOARD_TOP_N}
      - CLICKHOUSE_LEADERBOARD_CLEANUP_INTERVAL_MINUTES=${CLICKHOUSE_LEADERBOARD_CLEANUP_INTERVAL_MINUTES}
      - CLICKHOUSE_LEADERBOARD_RETENTION_MINUTES=${CLICKHOUSE_LEADERBOARD_RETENTION_MINUTES}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      # 价格刷新服务配置
      - PRICE_REFRESH_CRON=${PRICE_REFRESH_CRON}
      - PRICE_REFRESH_MAX_PER_MINUTE=${PRICE_REFRESH_MAX_PER_MINUTE}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # klinecharts-pro 构建服务（自定义 K线图表库）
  # ============================================================================
  klinecharts-pro-builder:
    build:
      context: ./frontend/klinecharts-pro
      dockerfile: Dockerfile
    container_name: aifuturetrade-klinecharts-pro-builder
    # 此服务仅用于构建，构建产物通过 volume 挂载到前端服务
    # 注意：构建在 Dockerfile 的 RUN 阶段完成，构建产物在镜像中
    # volume 挂载会将主机目录挂载到容器，覆盖镜像中的内容
    volumes:
      - ./frontend/klinecharts-pro/dist:/app/dist
    # 不暴露端口，仅用于构建
    networks:
      - aifuturetrade-network
    # 使用健康检查确保构建产物存在
    # 检查 dist 目录和关键文件是否存在
    healthcheck:
      test: ["CMD-SHELL", "test -d /app/dist && (test -f /app/dist/klinecharts-pro.js || test -f /app/dist/index.js)"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 90s  # 给构建足够的时间完成
    # 启动时确保构建产物已复制到 volume 挂载目录
    # 如果 volume 目录为空，从镜像中的构建产物复制（虽然通常构建已在 Dockerfile 中完成）
    # 保持容器运行，确保健康检查可以执行
    # frontend 会等待此服务的健康检查通过后才启动
    command: sh -c "echo 'klinecharts-pro build completed' && if [ ! -f /app/dist/klinecharts-pro.js ] && [ -f /app/dist/index.js ]; then echo 'Build files verified'; fi && tail -f /dev/null"

  # ============================================================================
  # 前端服务（Node.js Express）
  # ============================================================================
  frontend:
    build:
      context: .  # 使用项目根目录作为构建上下文，以便访问static目录
      dockerfile: ./frontend/Dockerfile
      # 注意：默认情况下，如果镜像已存在，docker compose up 不会重新构建
      # 需要代码变化时重新构建，请使用: docker compose up -d --build
    container_name: aifuturetrade-frontend
    ports:
      - "3000:3000"  # 前端服务端口
    environment:
      - BACKEND_URL=http://backend:5002
      - FRONTEND_PORT=3000
    volumes:
      # 挂载 klinecharts-pro 构建产物
      - ./frontend/klinecharts-pro/dist:/app/klinecharts-pro-dist:ro
    depends_on:
      backend:
        condition: service_started
      klinecharts-pro-builder:
        condition: service_healthy  # 确保 klinecharts-pro 构建完成且健康检查通过
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # 异步代理服务（后台数据同步）
  # ============================================================================
  async-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-async-agent
    command: ["python", "async/async_agent.py", "--task", "all"]
    # 注意：async-agent 是后台数据同步服务，不需要暴露端口
    volumes:
      - ./data:/app/data
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=/app
      # ClickHouse配置
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_TICKER_TABLE=${CLICKHOUSE_MARKET_TICKER_TABLE}
      - CLICKHOUSE_LEADERBOARD_TABLE=${CLICKHOUSE_LEADERBOARD_TABLE}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # K线同步配置
      - KLINE_SYNC_CHECK_INTERVAL=${KLINE_SYNC_CHECK_INTERVAL}
      - KLINE_CLEANUP_CRON=${KLINE_CLEANUP_CRON}
      - KLINE_CLEANUP_RETENTION_DAYS=${KLINE_CLEANUP_RETENTION_DAYS}
      # Data Agent配置
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL}
      - DATA_AGENT_PORT=${DATA_AGENT_PORT}
      - DATA_AGENT_REGISTER_IP=${DATA_AGENT_REGISTER_IP}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT}
      - DATA_AGENT_STATUS_CHECK_INTERVAL=${DATA_AGENT_STATUS_CHECK_INTERVAL}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # Data Manager服务（数据代理管理器）
  # ============================================================================
  # 此服务负责管理所有 data_agent 实例，包括注册、心跳、任务分配等
  data-manager:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-data-manager
    command: ["python", "data/data_manager.py"]
    # Data Manager服务端口（用于接收 data_agent 的注册和心跳）
    ports:
      - "8888:8888"  # Data Manager注册接口端口
    volumes:
      - ./data:/app/data
    # 依赖 async-agent，确保 async-agent 先启动（提供 market_tickers 数据）
    depends_on:
      - async-agent
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=/app
      # ClickHouse配置
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_TICKER_TABLE=${CLICKHOUSE_MARKET_TICKER_TABLE}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # Data Agent配置
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE}
      - DATA_AGENT_COMMAND_TIMEOUT=${DATA_AGENT_COMMAND_TIMEOUT}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT}
      - DATA_AGENT_STATUS_CHECK_INTERVAL=${DATA_AGENT_STATUS_CHECK_INTERVAL}
      - DATA_AGENT_FULL_SYNC_INTERVAL=${DATA_AGENT_FULL_SYNC_INTERVAL}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # Data Agent服务（K线数据同步）
  # ============================================================================
  # 注意：在 Docker 网络中，DATA_AGENT_REGISTER_IP 应设置为服务名 'data-manager'
  data-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-data-agent
    command: ["python", "data/data_agent.py"]
    # Data Agent服务端口
    ports:
      - "9999:9999"  # Data Agent指令接口端口
    volumes:
      - ./data:/app/data
    # 依赖 data-manager，确保 data-manager 先启动（用于注册）
    depends_on:
      - data-manager
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=/app
      # ClickHouse配置
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # Data Agent配置
      # 注意：在 Docker 网络中，DATA_AGENT_REGISTER_IP 应设置为服务名 'data-manager'
      # 如果未设置环境变量，使用 'data-manager' 作为默认值
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL}
      - DATA_AGENT_PORT=${DATA_AGENT_PORT}
      - DATA_AGENT_REGISTER_IP=${DATA_AGENT_REGISTER_IP:-data-manager}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT}
      - DATA_AGENT_SELF_UPDATE_INTERVAL=${DATA_AGENT_SELF_UPDATE_INTERVAL}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

# ==============================================================================
# 网络配置
# ==============================================================================
networks:
  aifuturetrade-network:
    driver: bridge
