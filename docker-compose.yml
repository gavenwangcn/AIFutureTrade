# ==============================================================================
# Docker Compose 配置文件 - 主服务（默认启动）
# ==============================================================================
# 注意：version字段在新版本Docker Compose中已废弃，但保留以兼容旧版本
# 如果看到警告，可以安全地忽略或移除version字段
# ==============================================================================
# 使用说明：
# 1. 默认启动：docker-compose up -d（启动backend、frontend和async-agent服务）
# 2. 启动数据服务：docker-compose -f docker-compose-data.yml up -d（启动data-manager和data-agent服务）
# 3. 启动所有服务：docker-compose up -d && docker-compose -f docker-compose-data.yml up -d
# ==============================================================================

services:
  # ============================================================================
  # MySQL数据库服务
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: aifuturetrade-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=aifuturetrade_root123
      - MYSQL_DATABASE=aifuturetrade
      - MYSQL_USER=aifuturetrade
      - MYSQL_PASSWORD=aifuturetrade123
    volumes:
      - mysql_data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped
    networks:
      - aifuturetrade-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-paifuturetrade_root123"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # 后端服务（Python Flask API）
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-backend
    ports:
      - "5002:5002"  # 后端API端口
    volumes:
      - ./data:/app/data
    environment:
      # 基础配置
      - DATABASE_PATH=/app/data/trading_bot.db
      - USE_GUNICORN=true
      - FLASK_ENV=production
      # Gunicorn配置
      - GUNICORN_WORKERS=${GUNICORN_WORKERS}
      - GUNICORN_WORKER_CLASS=${GUNICORN_WORKER_CLASS}
      - GUNICORN_WORKER_CONNECTIONS=${GUNICORN_WORKER_CONNECTIONS}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT}
      - GUNICORN_KEEPALIVE=${GUNICORN_KEEPALIVE}
      - GUNICORN_MAX_REQUESTS=${GUNICORN_MAX_REQUESTS}
      # MySQL配置
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=aifuturetrade
      - MYSQL_PASSWORD=aifuturetrade123
      - MYSQL_DATABASE=aifuturetrade
      # ClickHouse配置（保留以兼容）
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_TICKER_TABLE=${CLICKHOUSE_MARKET_TICKER_TABLE}
      - CLICKHOUSE_LEADERBOARD_TABLE=${CLICKHOUSE_LEADERBOARD_TABLE}
      - CLICKHOUSE_LEADERBOARD_SYNC_INTERVAL=${CLICKHOUSE_LEADERBOARD_SYNC_INTERVAL}
      - CLICKHOUSE_LEADERBOARD_TIME_WINDOW=${CLICKHOUSE_LEADERBOARD_TIME_WINDOW}
      - CLICKHOUSE_LEADERBOARD_TOP_N=${CLICKHOUSE_LEADERBOARD_TOP_N}
      - CLICKHOUSE_LEADERBOARD_CLEANUP_INTERVAL_MINUTES=${CLICKHOUSE_LEADERBOARD_CLEANUP_INTERVAL_MINUTES}
      - CLICKHOUSE_LEADERBOARD_RETENTION_MINUTES=${CLICKHOUSE_LEADERBOARD_RETENTION_MINUTES}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      # 价格刷新服务配置
      - PRICE_REFRESH_CRON=${PRICE_REFRESH_CRON}
      - PRICE_REFRESH_MAX_PER_MINUTE=${PRICE_REFRESH_MAX_PER_MINUTE}
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # 前端服务（Node.js Express + klinecharts-pro）
  # ============================================================================
  # 注意：此服务会在构建时先构建 klinecharts-pro 基础库，然后构建前端应用
  # klinecharts-pro 的构建产物会自动复制到 public/klinecharts-pro/ 目录
  # 前端页面通过 /klinecharts-pro/ 路径访问这些文件
  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    container_name: aifuturetrade-frontend
    ports:
      - "3000:3000"  # 前端服务端口
    environment:
      - BACKEND_URL=http://backend:5002
      - FRONTEND_PORT=3000
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_started
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - aifuturetrade-network

  # ============================================================================
  # 异步代理服务（后台数据同步）
  # ============================================================================
  async-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aifuturetrade-async-agent
    command: ["python", "async/async_agent.py", "--task", "all"]
    # 注意：async-agent 是后台数据同步服务，不需要暴露端口
    volumes:
      - ./data:/app/data
    environment:
      # 设置PYTHONPATH，确保可以找到所有模块
      - PYTHONPATH=/app
      # MySQL配置
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=aifuturetrade
      - MYSQL_PASSWORD=aifuturetrade123
      - MYSQL_DATABASE=aifuturetrade
      # ClickHouse配置（保留以兼容）
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_MARKET_TICKER_TABLE=${CLICKHOUSE_MARKET_TICKER_TABLE}
      - CLICKHOUSE_LEADERBOARD_TABLE=${CLICKHOUSE_LEADERBOARD_TABLE}
      - CLICKHOUSE_MARKET_KLINES_TABLE=${CLICKHOUSE_MARKET_KLINES_TABLE}
      # K线同步配置
      - KLINE_SYNC_CHECK_INTERVAL=${KLINE_SYNC_CHECK_INTERVAL}
      - KLINE_CLEANUP_CRON=${KLINE_CLEANUP_CRON}
      - KLINE_CLEANUP_RETENTION_DAYS=${KLINE_CLEANUP_RETENTION_DAYS}
      # Data Agent配置
      - DATA_AGENT_MAX_SYMBOL=${DATA_AGENT_MAX_SYMBOL}
      - DATA_AGENT_PORT=${DATA_AGENT_PORT}
      - DATA_AGENT_REGISTER_IP=${DATA_AGENT_REGISTER_IP}
      - DATA_AGENT_REGISTER_PORT=${DATA_AGENT_REGISTER_PORT}
      - DATA_AGENT_BATCH_SYMBOL_SIZE=${DATA_AGENT_BATCH_SYMBOL_SIZE}
      - DATA_AGENT_HEARTBEAT_TIMEOUT=${DATA_AGENT_HEARTBEAT_TIMEOUT}
      - DATA_AGENT_STATUS_CHECK_INTERVAL=${DATA_AGENT_STATUS_CHECK_INTERVAL}
      # Binance配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - aifuturetrade-network

# ==============================================================================
# 网络配置
# ==============================================================================
networks:
  aifuturetrade-network:
    driver: bridge

# ==============================================================================
# 数据卷配置
# ==============================================================================
volumes:
  mysql_data:
